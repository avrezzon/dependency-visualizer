name: CI

on:
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Lint
        run: npm run lint -- -f json -o lint-results.json
        continue-on-error: true

      - name: Run Tests
        id: test
        run: npm test -- run --reporter=json --outputFile=test-results.json
        continue-on-error: true

      - name: Post Results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            function getIcon(isSuccess) { return isSuccess ? 'âœ…' : 'âŒ'; }
            function formatCount(num) { return num.toString().padStart(3, ' '); }

            let lintSuccess = true, lintErrors = 0, lintWarnings = 0, lintBody = '';
            try {
              if (fs.existsSync('lint-results.json')) {
                const lintResults = JSON.parse(fs.readFileSync('lint-results.json', 'utf8'));
                lintResults.forEach(result => {
                  lintErrors += result.errorCount;
                  lintWarnings += result.warningCount;
                });
                lintSuccess = lintErrors === 0 && lintWarnings === 0;
                const errorColor = lintErrors > 0 ? 'ğŸ”´' : 'ğŸŸ¢';
                const warningColor = lintWarnings > 0 ? 'ğŸŸ¡' : 'ğŸŸ¢';
                lintBody = '## ' + getIcon(lintSuccess) + ' Lint Results\n\n| Metric | Count |\n|--------|-------|\n| ' + errorColor + ' Errors | ' + formatCount(lintErrors) + ' |\n| ' + warningColor + ' Warnings | ' + formatCount(lintWarnings) + ' |';
              } else {
                lintBody = '## âŒ Lint Results\n\nâš ï¸ Lint results file not found.';
                lintSuccess = false;
              }
            } catch (error) {
              lintBody = '## âŒ Lint Results\n\nâš ï¸ Error: ' + error.message;
              lintSuccess = false;
            }

            let testSuccess = false, testBody = '';
            try {
              if (fs.existsSync('test-results.json')) {
                const results = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
                testSuccess = results.success;
                const passedColor = results.numPassedTests === results.numTotalTests ? 'ğŸŸ¢' : 'ğŸŸ¡';
                const failedColor = results.numFailedTests > 0 ? 'ğŸ”´' : 'ğŸŸ¢';
                const suiteData = JSON.stringify({
                  numTotalTestSuites: results.numTotalTestSuites,
                  numPassedTestSuites: results.numPassedTestSuites,
                  numFailedTestSuites: results.numFailedTestSuites
                }, null, 2);
                testBody = '## ' + getIcon(testSuccess) + ' Test Results\n\n| Metric | Count |\n|--------|-------|\n| ğŸ“Š Total | ' + formatCount(results.numTotalTests) + ' |\n| ' + passedColor + ' Passed | ' + formatCount(results.numPassedTests) + ' |\n| ' + failedColor + ' Failed | ' + formatCount(results.numFailedTests) + ' |\n\n<details>\n<summary>ğŸ“‹ Test Suites</summary>\n\n```json\n' + suiteData + '\n```\n</details>';
              } else {
                testBody = '## âŒ Test Results\n\nâš ï¸ Test results file not found.';
              }
            } catch (error) {
              testBody = '## âŒ Test Results\n\nâš ï¸ Error: ' + error.message;
            }

            const finalBody = '### ğŸ” Automated Code Quality Check\n\n' + lintBody + '\n\n---\n\n' + testBody;
            
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: finalBody
              });
            } catch (e) {
               console.error("Failed to post comment: " + e.message);
            }
            
            if (!lintSuccess || !testSuccess) {
              const messages = [];
              if (!lintSuccess) messages.push('Linting failed (' + lintErrors + ' errors, ' + lintWarnings + ' warnings)');
              if (!testSuccess) messages.push('Tests failed');
              core.setFailed(messages.join(', '));
            }